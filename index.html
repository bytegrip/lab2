<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lab2 TRM - Schipschi Daniil</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        #status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            z-index: 10000;
            background-color: #ff3b3b;
            transition: background-color 0.3s ease;
        }
        #status.detected {
            background-color: #00ff88;
        }
        .click-indicator {
            position: fixed;
            color: white;
            font-size: 12px;
            font-family: Arial, sans-serif;
            font-weight: bold;
            pointer-events: none;
            z-index: 9999;
            animation: fadeOut 0.5s forwards;
            text-shadow: 0 0 3px rgba(0,0,0,0.8);
        }
        @keyframes fadeOut {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.5); }
        }
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9998;
            display: none;
        }
        #overlay.show {
            display: flex;
        }
        #overlay-message {
            color: white;
            font-size: 24px;
            font-family: Arial, sans-serif;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="status"></div>
    <div id="overlay">
        <div id="overlay-message">Scan first scene first!</div>
    </div>
    
    <a-scene mindar-image="imageTargetSrc: targets/targets3.mind; autoStart: false; filterMinCF: 0.0001; filterBeta: 10; maxTrack: 3" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false" renderer="antialias: true; colorManagement: true; sortObjects: true; physicallyCorrectLights: true; maxCanvasWidth: 1920; maxCanvasHeight: 1080">
        <a-assets>
            <a-asset-item id="egyptian-model" src="models/dance_like_an_egyptian.glb"></a-asset-item>
            <a-asset-item id="banana-model" src="models/banana_dancing_fortnite.glb"></a-asset-item>
            <a-asset-item id="pyramid-model" src="models/mayan_pyramid.glb"></a-asset-item>
            <a-asset-item id="cublosion-model" src="models/cublosion.glb"></a-asset-item>
            <a-asset-item id="viking-house-model" src="models/medieval_viking_house.glb"></a-asset-item>
            <a-asset-item id="blacksmith-model" src="models/blacksmith_animation.glb"></a-asset-item>
            <a-asset-item id="lair-model" src="models/the_lair_of_the_maekk.glb"></a-asset-item>
            <a-asset-item id="magic-girl-model" src="models/magic_girl.glb"></a-asset-item>
        </a-assets>
        
        <a-light type="ambient" intensity="0.6"></a-light>
        <a-light type="directional" intensity="1.2" position="1 1 1"></a-light>
        <a-light type="point" intensity="0.5" position="-2 2 2" color="#ffd700"></a-light>
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        
        <a-entity mindar-image-target="targetIndex: 0">
            <a-plane id="ground-plane" position="0 -0.5 -3" rotation="-90 0 0" width="8" height="8" color="#d2b48c" material="side: double; roughness: 0.9"></a-plane>
            
            <a-entity gltf-model="#pyramid-model" position="-1.5 -0.5 -3" rotation="0 20 0" scale="0.10 0.10 0.10"></a-entity>
            <a-entity gltf-model="#pyramid-model" position="0 -0.5 -3.5" rotation="0 0 0" scale="0.05 0.05 0.05"></a-entity>
            <a-entity gltf-model="#pyramid-model" position="1.5 -0.5 -3" rotation="0 -30 0" scale="0.08 0.08 0.08"></a-entity>
            
            <a-entity id="banana-left" gltf-model="#banana-model" position="-0.8 -0.5 0" rotation="0 0 0" scale="0.3 0.3 0.3" visible="false"></a-entity>
            <a-entity id="banana-right" gltf-model="#banana-model" position="0.8 -0.5 0" rotation="0 0 0" scale="0.3 0.3 0.3" visible="false"></a-entity>
            
            <a-entity 
                id="model-container"
                gltf-model="#egyptian-model"
                scale="0.25 0.25 0.25"
                position="0 -0.5 0"
                rotation="0 0 0"
                animation-mixer="clip: Static Pose">
            </a-entity>
            
            <a-entity id="cube-container"></a-entity>
        </a-entity>
        
        <a-entity mindar-image-target="targetIndex: 1">
            <a-entity id="viking-house" gltf-model="#viking-house-model" position="0 -0.5 -2" rotation="0 -90 0" scale="0.2 0.2 0.2" visible="false"></a-entity>
            
            <a-entity 
                id="blacksmith"
                gltf-model="#blacksmith-model"
                scale="0.0036 0.0036 0.0036"
                position="0.5 -0.5 0.5"
                rotation="0 -45 0"
                visible="false">
            </a-entity>
            
            <a-entity id="cube-container-2"></a-entity>
        </a-entity>
        
        <a-entity mindar-image-target="targetIndex: 2">
            <a-entity id="lair-house" gltf-model="#lair-model" position="0 -0.5 -2" rotation="0 0 0" scale="0.0007 0.0007 0.0007" visible="false"></a-entity>
            
            <a-entity id="cube-container-3"></a-entity>
        </a-entity>
    </a-scene>
    
    <script>
        window.addEventListener('load', async function() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const cameras = devices.filter(d => d.kind === 'videoinput');
            
            const sceneEl = document.querySelector('a-scene');
            
            if (sceneEl.hasLoaded) {
                startAR(cameras);
            } else {
                sceneEl.addEventListener('loaded', () => startAR(cameras));
            }
        });
        
        async function startAR(cameras) {
            if (cameras.length > 0) {
                const deviceId = cameras[0].deviceId;
                const sceneEl = document.querySelector('a-scene');
                const mindarSystem = sceneEl.systems['mindar-image-system'];
                
                if (mindarSystem) {
                    await mindarSystem.start({ 
                        video: { 
                            deviceId: { exact: deviceId },
                            width: { exact: 1920 },
                            height: { exact: 1080 },
                            aspectRatio: { exact: 16/9 }
                        } 
                    });
                }
            }
            
            const targets = document.querySelectorAll('[mindar-image-target]');
            const target1 = targets[0];
            const target2 = targets[1];
            const target3 = targets[2];
            const status = document.getElementById('status');
            const overlay = document.getElementById('overlay');
            const overlayMessage = document.getElementById('overlay-message');
            const modelContainer = document.getElementById('model-container');
            const bananaLeft = document.getElementById('banana-left');
            const bananaRight = document.getElementById('banana-right');
            const cubeContainer = document.getElementById('cube-container');
            const vikingHouse = document.getElementById('viking-house');
            const blacksmith = document.getElementById('blacksmith');
            const cubeContainer2 = document.getElementById('cube-container-2');
            const lairHouse = document.getElementById('lair-house');
            const cubeContainer3 = document.getElementById('cube-container-3');
            
            let isActivated = false;
            let isActivated2 = false;
            let isActivated3 = false;
            let firstSceneScanned = false;
            let secondSceneScanned = false;
            let currentTarget = null;
            let music1 = null;
            let music2 = null;
            let music3 = null;
            let egyptianMixer = null;
            let bananaLeftMixer = null;
            let bananaRightMixer = null;
            let blacksmithMixer = null;
            let vikingHouseMixer = null;
            let lairMixer = null;
            const cubeMixers = [];
            const cubeMixers2 = [];
            const cubeMixers3 = [];
            
            modelContainer.addEventListener('model-loaded', () => {
                const gltfComponent = modelContainer.components['gltf-model'];
                if (gltfComponent && gltfComponent.model && gltfComponent.model.animations) {
                    const animations = gltfComponent.model.animations;
                    egyptianMixer = new THREE.AnimationMixer(gltfComponent.model);
                    const staticClip = THREE.AnimationClip.findByName(animations, 'Static Pose');
                    
                    if (staticClip) {
                        const action = egyptianMixer.clipAction(staticClip);
                        action.setLoop(THREE.LoopRepeat);
                        action.play();
                    }
                }
            });
            
            bananaLeft.addEventListener('model-loaded', () => {
                const gltfComponent = bananaLeft.components['gltf-model'];
                if (gltfComponent && gltfComponent.model && gltfComponent.model.animations) {
                    const animations = gltfComponent.model.animations;
                    bananaLeftMixer = new THREE.AnimationMixer(gltfComponent.model);
                    const clip = THREE.AnimationClip.findByName(animations, 'Emote AfroHouse');
                    
                    if (clip) {
                        const action = bananaLeftMixer.clipAction(clip);
                        action.setLoop(THREE.LoopRepeat);
                        action.play();
                    }
                }
            });
            
            bananaRight.addEventListener('model-loaded', () => {
                const gltfComponent = bananaRight.components['gltf-model'];
                if (gltfComponent && gltfComponent.model && gltfComponent.model.animations) {
                    const animations = gltfComponent.model.animations;
                    bananaRightMixer = new THREE.AnimationMixer(gltfComponent.model);
                    const clip = THREE.AnimationClip.findByName(animations, 'Emote Boogie Down');
                    
                    if (clip) {
                        const action = bananaRightMixer.clipAction(clip);
                        action.setLoop(THREE.LoopRepeat);
                        action.play();
                    }
                }
            });
            
            blacksmith.addEventListener('model-loaded', () => {
                const gltfComponent = blacksmith.components['gltf-model'];
                if (gltfComponent && gltfComponent.model && gltfComponent.model.animations) {
                    const animations = gltfComponent.model.animations;
                    blacksmithMixer = new THREE.AnimationMixer(gltfComponent.model);
                    const takeClip = THREE.AnimationClip.findByName(animations, 'Take 001');
                    
                    if (takeClip) {
                        const action = blacksmithMixer.clipAction(takeClip);
                        action.setLoop(THREE.LoopRepeat);
                        action.play();
                    }
                }
            });
            
            vikingHouse.addEventListener('model-loaded', () => {
                const gltfComponent = vikingHouse.components['gltf-model'];
                if (gltfComponent && gltfComponent.model && gltfComponent.model.animations) {
                    const animations = gltfComponent.model.animations;
                    vikingHouseMixer = new THREE.AnimationMixer(gltfComponent.model);
                    const takeClip = THREE.AnimationClip.findByName(animations, 'Take 001');
                    
                    if (takeClip) {
                        const action = vikingHouseMixer.clipAction(takeClip);
                        action.setLoop(THREE.LoopRepeat);
                        action.play();
                    }
                }
            });
            
            lairHouse.addEventListener('model-loaded', () => {
                const gltfComponent = lairHouse.components['gltf-model'];
                if (gltfComponent && gltfComponent.model && gltfComponent.model.animations) {
                    const animations = gltfComponent.model.animations;
                    lairMixer = new THREE.AnimationMixer(gltfComponent.model);
                    const firefliesClip = THREE.AnimationClip.findByName(animations, 'Fireflies|Fireflies');
                    
                    if (firefliesClip) {
                        const action = lairMixer.clipAction(firefliesClip);
                        action.setLoop(THREE.LoopRepeat);
                        action.play();
                    }
                }
            });
            
            const clock = new THREE.Clock();
            function animationLoop() {
                requestAnimationFrame(animationLoop);
                const delta = clock.getDelta();
                
                if (egyptianMixer) egyptianMixer.update(delta);
                if (bananaLeftMixer) bananaLeftMixer.update(delta);
                if (bananaRightMixer) bananaRightMixer.update(delta);
                if (blacksmithMixer) blacksmithMixer.update(delta);
                if (vikingHouseMixer) vikingHouseMixer.update(delta);
                if (lairMixer) lairMixer.update(delta);
                
                cubeMixers.forEach(mixer => mixer.update(delta));
                cubeMixers2.forEach(mixer => mixer.update(delta));
                cubeMixers3.forEach(mixer => mixer.update(delta));
            }
            animationLoop();
            
            function stopAllMusic() {
                if (music1) {
                    music1.pause();
                    music1.currentTime = 0;
                }
                if (music2) {
                    music2.pause();
                    music2.currentTime = 0;
                }
                if (music3) {
                    music3.pause();
                    music3.currentTime = 0;
                }
            }
            
            document.addEventListener('click', (event) => {
                const clickIndicator = document.createElement('div');
                clickIndicator.className = 'click-indicator';
                clickIndicator.textContent = 'Click!';
                clickIndicator.style.left = event.clientX + 'px';
                clickIndicator.style.top = event.clientY + 'px';
                document.body.appendChild(clickIndicator);
                
                setTimeout(() => {
                    clickIndicator.remove();
                }, 500);
                
                if (currentTarget === 1 && !isActivated) {
                    isActivated = true;
                    
                    stopAllMusic();
                    music1 = new Audio('models/music.mp3');
                    music1.volume = 1.0;
                    music1.loop = true;
                    music1.play().then(() => {
                        console.log('Music playing');
                    }).catch(e => {
                        console.log('Audio play error:', e);
                    });
                    
                    bananaLeft.setAttribute('visible', 'true');
                    bananaRight.setAttribute('visible', 'true');
                    
                    if (egyptianMixer) {
                        const gltfComponent = modelContainer.components['gltf-model'];
                        const animations = gltfComponent.model.animations;
                        egyptianMixer.stopAllAction();
                        
                        const danceClip = THREE.AnimationClip.findByName(animations, 'pyramiddance');
                        if (danceClip) {
                            const danceAction = egyptianMixer.clipAction(danceClip);
                            danceAction.setLoop(THREE.LoopRepeat);
                            danceAction.reset();
                            danceAction.play();
                        }
                    }
                }
                
                if (currentTarget === 2 && !isActivated2) {
                    isActivated2 = true;
                    
                    stopAllMusic();
                    music2 = new Audio('models/medieval.mp3');
                    music2.volume = 1.0;
                    music2.loop = true;
                    music2.play().then(() => {
                        console.log('Medieval music playing');
                    }).catch(e => {
                        console.log('Audio play error:', e);
                    });
                    
                    blacksmith.setAttribute('visible', 'true');
                }
                
                if (currentTarget) {
                    if (currentTarget === 1) {
                        const randomX = (Math.random() - 0.5) * 2;
                        const randomZ = -0.5 + (Math.random() * -2.5);
                        
                        const cube = document.createElement('a-entity');
                        cube.setAttribute('gltf-model', '#cublosion-model');
                        cube.setAttribute('position', `${randomX} -0.45 ${randomZ}`);
                        cube.setAttribute('scale', '0.15 0.15 0.15');
                        cube.setAttribute('rotation', '0 0 0');
                        cubeContainer.appendChild(cube);
                        
                        cube.addEventListener('model-loaded', () => {
                            const cubeComponent = cube.components['gltf-model'];
                            if (cubeComponent && cubeComponent.model && cubeComponent.model.animations) {
                                const cubeAnimations = cubeComponent.model.animations;
                                const cubeMixer = new THREE.AnimationMixer(cubeComponent.model);
                                const explosionClip = THREE.AnimationClip.findByName(cubeAnimations, 'Animation');
                                
                                if (explosionClip) {
                                    const explosionAction = cubeMixer.clipAction(explosionClip);
                                    explosionAction.setLoop(THREE.LoopOnce);
                                    explosionAction.clampWhenFinished = true;
                                    explosionAction.time = 2.06;
                                    explosionAction.play();
                                    cubeMixers.push(cubeMixer);
                                    
                                    setTimeout(() => {
                                        cube.remove();
                                        const index = cubeMixers.indexOf(cubeMixer);
                                        if (index > -1) cubeMixers.splice(index, 1);
                                    }, (explosionClip.duration - 2.06) * 1000 + 1000);
                                }
                            }
                        });
                    }
                }
            });
            
            target1.addEventListener('targetFound', () => {
                status.classList.add('detected');
                currentTarget = 1;
                firstSceneScanned = true;
            });
            
            target1.addEventListener('targetLost', () => {
                status.classList.remove('detected');
                currentTarget = null;
            });
            
            target2.addEventListener('targetFound', () => {
                if (!firstSceneScanned) {
                    overlay.classList.add('show');
                    overlayMessage.textContent = 'Scan first scene first!';
                } else {
                    overlay.classList.remove('show');
                    status.classList.add('detected');
                    currentTarget = 2;
                    secondSceneScanned = true;
                    
                    vikingHouse.setAttribute('visible', 'true');
                }
            });
            
            target2.addEventListener('targetLost', () => {
                overlay.classList.remove('show');
                status.classList.remove('detected');
                currentTarget = null;
            });
            
            target3.addEventListener('targetFound', () => {
                if (!secondSceneScanned) {
                    overlay.classList.add('show');
                    overlayMessage.textContent = 'Scan second scene first!';
                } else {
                    overlay.classList.remove('show');
                    status.classList.add('detected');
                    currentTarget = 3;
                    
                    lairHouse.setAttribute('visible', 'true');
                    
                    if (!isActivated3) {
                        isActivated3 = true;
                        stopAllMusic();
                        music3 = new Audio('models/magic.mp3');
                        music3.volume = 1.0;
                        music3.loop = true;
                        music3.play().then(() => {
                            console.log('Magic music playing');
                        }).catch(e => {
                            console.log('Audio play error:', e);
                        });
                    }
                }
            });
            
            target3.addEventListener('targetLost', () => {
                overlay.classList.remove('show');
                status.classList.remove('detected');
                currentTarget = null;
            });
        }
    </script>
</body>
</html>
